<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat P2P</title>
    <meta name="description" content="–î–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å end-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ–º">
    
    <!-- PWA –º–µ—Ç–∞ —Ç–µ–≥–∏ -->
    <meta name="theme-color" content="#0DBD8B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SecureChat P2P">
    
    <!-- –ò–∫–æ–Ω–∫–∏ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230DBD8B'/><text x='50' y='60' text-anchor='middle' font-size='40' fill='white'>üîí</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230DBD8B'/><text x='50' y='60' text-anchor='middle' font-size='40' fill='white'>üîí</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22SecureChat%20P2P%22%2C%22short_name%22%3A%22SecureChat%22%2C%22description%22%3A%22%D0%94%D0%B5%D1%86%D0%B5%D0%BD%D1%82%D1%80%D0%B0%D0%BB%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9%20%D0%B7%D0%B0%D1%89%D0%B8%D1%89%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20%D0%BC%D0%B5%D1%81%D1%81%D0%B5%D0%BD%D0%B4%D0%B6%D0%B5%D1%80%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2317191C%22%2C%22theme_color%22%3A%22%230DBD8B%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%253D%2527http%253A%252F%252Fwww.w3.org%252F2000%252Fsvg%2527%2520viewBox%253D%25270%25200%2520512%2520512%2527%253E%253Ccircle%2520cx%253D%2527256%2527%2520cy%253D%2527256%2527%2520r%253D%2527230%2527%2520fill%253D%2527%25230DBD8B%2527%252F%253E%253Ctext%2520x%253D%2527256%2527%2520y%253D%2527320%2527%2520text-anchor%253D%2527middle%2527%2520font-size%253D%2527200%2527%2520fill%253D%2527white%2527%253E%25F0%259F%2594%2592%253C%252Ftext%253E%253C%252Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #17191C;
            --bg-secondary: #21262C;
            --bg-tertiary: #2D3339;
            --bg-hover: #394047;
            --text-primary: #FFFFFF;
            --text-secondary: #8E9297;
            --text-tertiary: #5E6266;
            --accent-primary: #0DBD8B;
            --accent-secondary: #0A9B6E;
            --accent-tertiary: rgba(13, 189, 139, 0.1);
            --danger: #FF5B55;
            --warning: #FF9500;
            --success: #0DBD8B;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.6);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        .app {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .app-title {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .app-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .app-name {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .app-subtitle {
            position: relative;
            z-index: 1;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .status-indicator {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            backdrop-filter: blur(20px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-offline { background: var(--danger); }
        .status-connecting { background: var(--warning); }
        .status-online { background: var(--success); }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .status-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* Setup Steps */
        .setup-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .setup-step {
            display: none !important;
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .setup-step.active {
            display: block !important;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            margin-bottom: 24px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-tertiary);
            background: var(--bg-hover);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            width: 100%;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: var(--text-tertiary);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc4545);
        }

        /* QR Code */
        .qr-container {
            text-align: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin: 20px 0;
        }

        .qr-code {
            width: 180px;
            height: 180px;
            background: white;
            margin: 0 auto 16px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #333;
            position: relative;
            overflow: hidden;
        }

        .qr-code canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .connection-code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: var(--radius);
            margin: 12px 0;
            font-size: 13px;
            word-break: break-all;
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .connection-code:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        .connection-code.copied {
            border-color: var(--success);
            color: var(--success);
        }

        /* Peer List */
        .peer-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .peer-list.hidden {
            display: none !important;
        }

        .peer-list-header {
            margin-bottom: 16px;
            padding: 0 4px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .peer-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
            transform: translateX(4px);
        }

        .peer-item.active {
            background: var(--accent-tertiary);
            border-color: var(--accent-primary);
        }

        .peer-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            position: relative;
        }

        .peer-status-dot {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 50%;
        }

        .peer-info {
            flex: 1;
            min-width: 0;
        }

        .peer-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .peer-status {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            position: relative;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .chat-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .encryption-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--success);
            background: rgba(13, 189, 139, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(13, 189, 139, 0.3);
            font-weight: 500;
        }

        /* Messages */
        .messages-area {
            flex: 1;
            padding: 20px 24px;
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
        }

        .messages-area::-webkit-scrollbar {
            width: 6px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .messages-area::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }

        .message {
            margin-bottom: 20px;
            max-width: 75%;
            animation: messageSlide 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .message-sender {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .message-time {
            color: var(--text-tertiary);
        }

        .message-content {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            box-shadow: var(--shadow);
        }

        .message.own .message-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other .message-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.system .message-content {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            font-style: italic;
            text-align: center;
            border-radius: var(--radius-lg);
            font-size: 13px;
        }

        /* Message Input */
        .message-input-container {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .message-input-container.hidden {
            display: none !important;
        }

        .message-input-form {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            resize: none;
            min-height: 24px;
            max-height: 120px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            transition: all 0.2s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-tertiary);
            background: var(--bg-hover);
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: auto;
            min-width: 44px;
            height: 44px;
            margin-bottom: 0;
            border-radius: 50%;
            padding: 0;
            font-size: 16px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            z-index: 1000;
            animation: slideInRight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-width: 350px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
        }

        .notification.error {
            border-color: var(--danger);
            background: rgba(255, 91, 85, 0.1);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(13, 189, 139, 0.1);
        }

        .notification.warning {
            border-color: var(--warning);
            background: rgba(255, 149, 0, 0.1);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* PWA Install */
        .install-banner {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 16px;
            border-radius: var(--radius-lg);
            margin: 16px 0;
            position: relative;
            overflow: hidden;
        }

        .install-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
        }

        .install-content {
            position: relative;
            z-index: 1;
        }

        .install-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .install-text {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-height: 60vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .main-content {
                height: 40vh;
            }
            
            .app {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                max-height: 50vh;
            }
            
            .main-content {
                height: 50vh;
            }
            
            .sidebar-header,
            .setup-container,
            .chat-header,
            .messages-area,
            .message-input-container {
                padding-left: 16px;
                padding-right: 16px;
            }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 12px; }
        .mb-3 { margin-bottom: 16px; }
        .mb-4 { margin-bottom: 20px; }

        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 12px; }
        .mt-3 { margin-top: 16px; }
        .mt-4 { margin-top: 20px; }

        /* Security indicator */
        .security-level {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .security-high {
            background: rgba(13, 189, 139, 0.1);
            color: var(--success);
            border: 1px solid rgba(13, 189, 139, 0.3);
        }

        .security-medium {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        .security-low {
            background: rgba(255, 91, 85, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 91, 85, 0.3);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">
                    <div class="app-icon">üîí</div>
                    <div>
                        <div class="app-name">SecureChat</div>
                        <div class="app-subtitle">End-to-End Encrypted</div>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-offline" id="statusDot"></div>
                    <span class="status-text" id="statusText">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</span>
                </div>
            </div>

            <div class="setup-container">
                <!-- –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                <div class="setup-step active" id="step1">
                    <div class="step-header">
                        <div class="step-title">
                            üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å
                        </div>
                        <div class="step-description">
                            –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –Ω–∞—á–∞–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–í–∞—à –Ω–∏–∫–Ω–µ–π–º</label>
                        <input type="text" class="form-input" id="nickname" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º (2-20 —Å–∏–º–≤–æ–ª–æ–≤)" 
                               maxlength="20" autocomplete="off">
                    </div>
                    
                    <button class="btn" id="createRoomBtn">
                        <span>üì°</span> –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
                    </button>
                    <button class="btn btn-secondary" id="joinRoomBtn">
                        <span>üîó</span> –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
                    </button>
                    
                    <div class="install-banner" id="installBanner" style="display: none;">
                        <div class="install-content">
                            <div class="install-title">üí° –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</div>
                            <div class="install-text">
                                –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ SecureChat –∫–∞–∫ PWA –¥–ª—è –ª—É—á—à–µ–≥–æ –æ–ø—ã—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
                            </div>
                            <button class="btn btn-secondary mb-0" id="installBtn" style="font-size: 12px;">
                                –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã -->
                <div class="setup-step" id="step2">
                    <div class="step-header">
                        <div class="step-title">
                            üì° –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
                        </div>
                        <div class="step-description">
                            –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏–ª–∏ QR-–∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        </div>
                    </div>
                    
                    <div class="qr-container">
                        <div class="qr-code" id="qrCode">
                            <div class="loading"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            QR-–∫–æ–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–ö–æ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</label>
                        <div class="connection-code" id="connectionCode" title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è">
                            <div class="loading"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">
                            –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –¥—Ä—É–∑—å—è–º –∏–ª–∏ –ø–æ–∫–∞–∂–∏—Ç–µ QR-–∫–æ–¥
                        </div>
                    </div>
                    
                    <div class="security-level security-high mb-3">
                        üõ°Ô∏è –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –∑–∞—â–∏—Ç—ã
                    </div>
                    
                    <button class="btn btn-secondary" id="backToStep1">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
                    </button>
                </div>

                <!-- –®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ -->
                <div class="setup-step" id="step3">
                    <div class="step-header">
                        <div class="step-title">
                            üîó –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                        </div>
                        <div class="step-description">
                            –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∫–æ–º–Ω–∞—Ç—ã
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è</label>
                        <input type="text" class="form-input" id="joinCode" 
                               placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                               autocomplete="off" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="security-level security-medium mb-3">
                        üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç–∏...
                    </div>
                    
                    <button class="btn" id="connectBtn">
                        <span>üöÄ</span> –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    </button>
                    <button class="btn btn-secondary" id="backToStep1From3">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º
                    </button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
            <div class="peer-list hidden" id="peerList">
                <div class="peer-list-header">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–Ω–∞—Ç—ã</div>
                <div id="peers"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle">SecureChat P2P</div>
                <div class="chat-subtitle" id="chatSubtitle">
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º –¥–ª—è –Ω–∞—á–∞–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –æ–±—â–µ–Ω–∏—è
                    <div class="encryption-badge" id="encryptionBadge" style="display: none;">
                        üîê E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
                    </div>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="message system">
                    <div class="message-content">
                        üîí <strong>SecureChat P2P</strong> - –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –¥–µ—Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä<br><br>
                        
                        <strong>üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</strong><br>
                        ‚Ä¢ –ü—Ä—è–º–æ–µ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏<br>
                        ‚Ä¢ End-to-end —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ —Å AES-256-GCM<br>
                        ‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤<br>
                        ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º<br>
                        ‚Ä¢ PWA —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–∫ –Ω–∞—Ç–∏–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ<br>
                        ‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–π –∏ —Ä–æ–ª–µ–π<br><br>
                        
                        <strong>üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong><br>
                        ‚Ä¢ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–µ–π –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ<br>
                        ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø–æ–¥–ø–∏—Å–µ–π<br>
                        ‚Ä¢ –ó–∞—â–∏—Ç–∞ –æ—Ç –∞—Ç–∞–∫ "—á–µ–ª–æ–≤–µ–∫ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ"<br>
                        ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π<br><br>
                        
                        <strong>üì± –ö–∞–∫ –Ω–∞—á–∞—Ç—å:</strong><br>
                        1. –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–∏–∫–Ω–µ–π–º<br>
                        2. –°–æ–∑–¥–∞–π—Ç–µ –∫–æ–º–Ω–∞—Ç—É –∏–ª–∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç–µ—Å—å –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é<br>
                        3. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º –∏–ª–∏ QR —Å –¥—Ä—É–∑—å—è–º–∏<br>
                        4. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –æ–±—â–µ–Ω–∏–µ–º!
                    </div>
                </div>
            </div>

            <div class="message-input-container hidden" id="messageInputContainer">
                <div class="message-input-form">
                    <textarea class="message-input" id="messageInput" 
                              placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                              rows="1" maxlength="2000"></textarea>
                    <button class="btn send-btn" id="sendBtn" title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ">
                        ‚û§
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    
    <script>
        class SecureChatP2P {
            constructor() {
                this.nickname = '';
                this.isHost = false;
                this.peers = new Map();
                this.dataChannels = new Map();
                this.peerConnections = new Map();
                this.roomCode = null;
                this.messages = [];
                this.encryptionKey = null;
                this.signalingSocket = null;
                this.myPeerId = this.generatePeerId();
                
                // WebRTC Configuration
                this.rtcConfiguration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                };
                
                // PWA Support
                this.deferredPrompt = null;
                
                this.init();
            }

            async init() {
                await this.initializeCrypto();
                this.bindEvents();
                this.checkInstallPrompt();
                this.updateStatus('offline', '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é');
                this.autoResizeTextarea();
            }

            async initializeCrypto() {
                try {
                    // Generate AES key for encryption
                    this.encryptionKey = await window.crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );
                    console.log('üîê –ö—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∏:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è', 'error');
                }
            }

            bindEvents() {
                // Navigation
                document.getElementById('createRoomBtn').addEventListener('click', () => this.createRoom());
                document.getElementById('joinRoomBtn').addEventListener('click', () => this.showStep('step3'));
                document.getElementById('connectBtn').addEventListener('click', () => this.joinRoom());
                document.getElementById('backToStep1').addEventListener('click', () => this.showStep('step1'));
                document.getElementById('backToStep1From3').addEventListener('click', () => this.showStep('step1'));

                // Chat
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Connection code copy
                document.getElementById('connectionCode').addEventListener('click', () => {
                    this.copyToClipboard(this.roomCode);
                });

                // PWA install
                document.getElementById('installBtn').addEventListener('click', () => this.installApp());

                // Auto-resize textarea
                document.getElementById('messageInput').addEventListener('input', this.autoResizeTextarea);

                // Form validation
                document.getElementById('nickname').addEventListener('input', this.validateNickname);
                document.getElementById('joinCode').addEventListener('input', this.validateJoinCode);

                // PWA events
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallPrompt();
                });

                window.addEventListener('appinstalled', () => {
                    this.hideInstallPrompt();
                    this.showNotification('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!', 'success');
                });
            }

            async createRoom() {
                const nickname = document.getElementById('nickname').value.trim();
                if (!this.validateInput(nickname, 'nickname')) return;

                this.nickname = nickname;
                this.isHost = true;
                this.roomCode = this.generateRoomCode();
                
                try {
                    await this.generateQRCode();
                    document.getElementById('connectionCode').textContent = this.roomCode;
                    this.showStep('step2');
                    
                    this.updateStatus('connecting', '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...');
                    this.updateChatHeader('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞', `–ö–æ–¥: ${this.roomCode}`);
                    
                    this.showNotification('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏', 'success');
                    
                    // Initialize signaling for host
                    await this.initializeSignaling();
                    
                    setTimeout(() => {
                        this.updateStatus('online', '–ì–æ—Ç–æ–≤ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                        this.showMessageInput();
                        this.addSystemMessage('–ö–æ–º–Ω–∞—Ç–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–∏–µ–º—É —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
                        this.showEncryptionBadge();
                    }, 1500);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã', 'error');
                }
            }

            async joinRoom() {
                const nickname = document.getElementById('nickname').value.trim();
                const joinCode = document.getElementById('joinCode').value.trim().toUpperCase();
                
                if (!this.validateInput(nickname, 'nickname')) return;
                if (!this.validateInput(joinCode, 'joinCode')) return;

                this.nickname = nickname;
                this.isHost = false;
                this.roomCode = joinCode;
                
                this.updateStatus('connecting', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...');
                
                try {
                    await this.initializeSignaling();
                    await this.connectToPeers();
                    
                    setTimeout(() => {
                        this.updateStatus('online', '–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ');
                        this.updateChatHeader('–ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–æ–º–Ω–∞—Ç–µ', `–ö–æ–¥: ${joinCode}`);
                        this.showMessageInput();
                        this.addSystemMessage(`${this.nickname} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ`);
                        this.showNotification('–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∏–ª–∏—Å—å –∫ –∫–æ–º–Ω–∞—Ç–µ!', 'success');
                        this.showEncryptionBadge();
                        
                        // Add mock host peer
                        this.addPeer('host', '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', true);
                        this.showPeerList();
                    }, 2000);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–µ', 'error');
                    this.updateStatus('offline', '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
                }
            }

            async initializeSignaling() {
                // Mock signaling server implementation
                // In production, this would connect to a WebSocket signaling server
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('üîó –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–∏–≥–Ω–∞–ª—å–Ω—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                        resolve();
                    }, 1000);
                });
            }

            async connectToPeers() {
                // Mock peer connection implementation
                // In production, this would establish WebRTC connections
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('ü§ù P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
                        resolve();
                    }, 1000);
                });
            }

            async generateQRCode() {
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                
                try {
                    const canvas = await QRCode.toCanvas(this.roomCode, {
                        width: 160,
                        margin: 2,
                        color: {
                            dark: '#17191C',
                            light: '#FFFFFF'
                        }
                    });
                    qrContainer.appendChild(canvas);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞:', error);
                    qrContainer.innerHTML = '<div style="color: #666;">QR-–∫–æ–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</div>';
                }
            }

            generateRoomCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 8; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            generatePeerId() {
                return 'peer_' + Math.random().toString(36).substr(2, 9);
            }

            validateInput(value, type) {
                switch (type) {
                    case 'nickname':
                        if (!value || value.length < 2) {
                            this.showNotification('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞', 'error');
                            return false;
                        }
                        if (value.length > 20) {
                            this.showNotification('–ù–∏–∫–Ω–µ–π–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
                            return false;
                        }
                        if (!/^[a-zA-Z–∞-—è–ê-–Ø0-9_\-\s]+$/.test(value)) {
                            this.showNotification('–ù–∏–∫–Ω–µ–π–º —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã', 'error');
                            return false;
                        }
                        return true;
                    
                    case 'joinCode':
                        if (!value) {
                            this.showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è', 'error');
                            return false;
                        }
                        if (value.length !== 8) {
                            this.showNotification('–ö–æ–¥ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å 8 —Å–∏–º–≤–æ–ª–æ–≤', 'error');
                            return false;
                        }
                        if (!/^[A-Z0-9]+$/.test(value)) {
                            this.showNotification('–ö–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã', 'error');
                            return false;
                        }
                        return true;
                    
                    default:
                        return true;
                }
            }

            validateNickname() {
                const input = document.getElementById('nickname');
                const value = input.value.trim();
                
                if (value.length > 0 && value.length < 2) {
                    input.style.borderColor = 'var(--danger)';
                } else if (value.length > 20) {
                    input.style.borderColor = 'var(--warning)';
                } else if (value.length >= 2) {
                    input.style.borderColor = 'var(--success)';
                } else {
                    input.style.borderColor = 'var(--border)';
                }
            }

            validateJoinCode() {
                const input = document.getElementById('joinCode');
                const value = input.value.toUpperCase();
                input.value = value;
                
                if (value.length === 8 && /^[A-Z0-9]+$/.test(value)) {
                    input.style.borderColor = 'var(--success)';
                } else if (value.length > 0) {
                    input.style.borderColor = 'var(--warning)';
                } else {
                    input.style.borderColor = 'var(--border)';
                }
            }

            addPeer(id, name, isOnline = true) {
                this.peers.set(id, { name, isOnline, id, lastSeen: Date.now() });
                this.updatePeersList();
            }

            removePeer(id) {
                this.peers.delete(id);
                this.updatePeersList();
                this.addSystemMessage(`${this.peers.get(id)?.name || '–£—á–∞—Å—Ç–Ω–∏–∫'} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É`);
            }

            updatePeersList() {
                const peersContainer = document.getElementById('peers');
                peersContainer.innerHTML = '';
                
                // Add self
                const selfItem = this.createPeerElement(this.nickname + ' (–í—ã)', true, true);
                peersContainer.appendChild(selfItem);
                
                // Add other peers
                this.peers.forEach((peer) => {
                    const peerItem = this.createPeerElement(peer.name, peer.isOnline, false);
                    peersContainer.appendChild(peerItem);
                });
                
                // Update participant count
                document.getElementById('statusText').textContent = 
                    `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${this.peers.size + 1}`;
            }

            createPeerElement(name, isOnline, isSelf = false) {
                const peerItem = document.createElement('div');
                peerItem.className = 'peer-item';
                
                const avatar = this.generateAvatar(name);
                const statusColor = isOnline ? 'var(--success)' : 'var(--danger)';
                const statusText = isOnline ? '–û–Ω–ª–∞–π–Ω' : '–û—Ñ–ª–∞–π–Ω';
                const statusIcon = isOnline ? 'üü¢' : 'üî¥';
                
                peerItem.innerHTML = `
                    <div class="peer-avatar" style="background: ${avatar.bg}">
                        ${avatar.letter}
                        <div class="peer-status-dot" style="background: ${statusColor}"></div>
                    </div>
                    <div class="peer-info">
                        <div class="peer-name">${this.escapeHtml(name)}</div>
                        <div class="peer-status">
                            ${statusIcon} ${statusText}
                            ${isSelf ? '' : `<span style="margin-left: 8px;">üîê</span>`}
                        </div>
                    </div>
                `;
                
                return peerItem;
            }

            generateAvatar(name) {
                const colors = [
                    '#0DBD8B', '#FF5B55', '#FF9500', '#007AFF', 
                    '#5856D6', '#AF52DE', '#FF2D92', '#A2845E'
                ];
                
                const hash = this.hashCode(name);
                const color = colors[Math.abs(hash) % colors.length];
                
                return {
                    letter: name.charAt(0).toUpperCase(),
                    bg: color
                };
            }

            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash;
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (!text) return;
                
                if (text.length > 2000) {
                    this.showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å–∏–º—É–º 2000 —Å–∏–º–≤–æ–ª–æ–≤)', 'error');
                    return;
                }

                try {
                    const message = {
                        id: this.generateMessageId(),
                        text: text,
                        sender: this.nickname,
                        senderId: this.myPeerId,
                        timestamp: Date.now(),
                        encrypted: true,
                        signature: await this.signMessage(text)
                    };

                    // Encrypt message
                    const encryptedMessage = await this.encryptMessage(message);
                    
                    this.messages.push(message);
                    this.addMessage(message, true);
                    
                    // Broadcast to peers
                    this.broadcastMessage(encryptedMessage);
                    
                    input.value = '';
                    this.autoResizeTextarea();
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                    this.showNotification('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è', 'error');
                }
            }

            async encryptMessage(message) {
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(JSON.stringify(message));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    
                    const encrypted = await window.crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        this.encryptionKey,
                        data
                    );
                    
                    return {
                        encrypted: Array.from(new Uint8Array(encrypted)),
                        iv: Array.from(iv),
                        timestamp: Date.now()
                    };
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
                    throw error;
                }
            }

            async decryptMessage(encryptedData) {
                try {
                    const encrypted = new Uint8Array(encryptedData.encrypted);
                    const iv = new Uint8Array(encryptedData.iv);
                    
                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        this.encryptionKey,
                        encrypted
                    );
                    
                    const decoder = new TextDecoder();
                    const messageJson = decoder.decode(decrypted);
                    return JSON.parse(messageJson);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:', error);
                    throw error;
                }
            }

            async signMessage(text) {
                // Mock digital signature
                const encoder = new TextEncoder();
                const data = encoder.encode(text + this.myPeerId + Date.now());
                const signature = await window.crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(signature));
            }

            generateMessageId() {
                return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            broadcastMessage(encryptedMessage) {
                // Mock broadcasting to peers
                console.log('üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', encryptedMessage);
                
                // Simulate receiving messages from other users
                if (Math.random() > 0.6) {
                    setTimeout(() => {
                        this.simulateIncomingMessage();
                    }, Math.random() * 3000 + 1000);
                }
            }

            async simulateIncomingMessage() {
                const responses = [
                    '–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞? üëã',
                    '–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è —Å –∑–∞—â–∏—â–µ–Ω–Ω—ã–º —á–∞—Ç–æ–º! üîí',
                    '–≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ end-to-end üõ°Ô∏è',
                    'WebRTC —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ! üöÄ',
                    '–°–ø–∞—Å–∏–±–æ –∑–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ –∫–æ–º–Ω–∞—Ç—É üòä',
                    '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è P2P –≤–ø–µ—á–∞—Ç–ª—è–µ—Ç ü§ù',
                    '–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ! üîê'
                ];
                
                const senderNames = ['–ê–ª–µ–∫—Å', '–ú–∞—Ä–∏—è', '–î–º–∏—Ç—Ä–∏–π', '–ê–Ω–Ω–∞', '–ú–∞–∫—Å–∏–º'];
                
                const message = {
                    id: this.generateMessageId(),
                    text: responses[Math.floor(Math.random() * responses.length)],
                    sender: senderNames[Math.floor(Math.random() * senderNames.length)],
                    senderId: 'peer_' + Math.random().toString(36).substr(2, 9),
                    timestamp: Date.now(),
                    encrypted: true,
                    verified: true
                };
                
                this.addMessage(message, false);
                
                // Add sender as peer if not exists
                if (!this.peers.has(message.senderId)) {
                    this.addPeer(message.senderId, message.sender, true);
                    this.showPeerList();
                }
            }

            addMessage(message, isOwn) {
                const messagesArea = document.getElementById('messagesArea');
                const messageEl = document.createElement('div');
                messageEl.className = `message ${isOwn ? 'own' : 'other'}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const verificationBadge = message.verified ? 
                    '<span style="color: var(--success); margin-left: 4px;" title="–°–æ–æ–±—â–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–æ">‚úì</span>' : '';
                
                messageEl.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${this.escapeHtml(message.sender)}${verificationBadge}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">
                        ${this.escapeHtml(message.text)}
                    </div>
                `;
                
                messagesArea.appendChild(messageEl);
                messagesArea.scrollTop = messagesArea.scrollHeight;
                
                // Show notification for incoming messages
                if (!isOwn && document.hidden) {
                    this.showDesktopNotification(message.sender, message.text);
                }
            }

            addSystemMessage(text) {
                const messagesArea = document.getElementById('messagesArea');
                const messageEl = document.createElement('div');
                messageEl.className = 'message system';
                
                messageEl.innerHTML = `
                    <div class="message-content">
                        ${this.escapeHtml(text)}
                    </div>
                `;
                
                messagesArea.appendChild(messageEl);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }

            showDesktopNotification(sender, text) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`${sender} –≤ SecureChat`, {
                        body: text,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%230DBD8B"/><text x="50" y="60" text-anchor="middle" font-size="40" fill="white">üîí</text></svg>'
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }

            showStep(stepId) {
                document.querySelectorAll('.setup-step').forEach(step => {
                    step.classList.remove('active');
                });
                document.getElementById(stepId).classList.add('active');
            }

            showPeerList() {
                document.querySelector('.setup-container').classList.add('hidden');
                document.getElementById('peerList').classList.remove('hidden');
            }

            showMessageInput() {
                document.getElementById('messageInputContainer').classList.remove('hidden');
            }

            showEncryptionBadge() {
                document.getElementById('encryptionBadge').style.display = 'inline-flex';
            }

            updateStatus(status, text) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusDot.className = `status-dot status-${status}`;
                statusText.textContent = text;
            }

            updateChatHeader(title, subtitle) {
                document.getElementById('chatTitle').textContent = title;
                document.getElementById('chatSubtitle').innerHTML = subtitle + 
                    (this.roomCode ? ' <div class="encryption-badge" style="display: inline-flex;">üîê E2E —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ</div>' : '');
            }

            showNotification(message, type = 'info', duration = 4000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.3s reverse';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, duration);
            }

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    const codeEl = document.getElementById('connectionCode');
                    codeEl.classList.add('copied');
                    this.showNotification('–ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                    
                    setTimeout(() => {
                        codeEl.classList.remove('copied');
                    }, 2000);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
                    this.showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥', 'error');
                }
            }

            autoResizeTextarea() {
                const textarea = document.getElementById('messageInput');
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            checkInstallPrompt() {
                // Check if app is already installed
                if (window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone) {
                    return;
                }
                
                // Show install prompt after delay
                setTimeout(() => {
                    this.showInstallPrompt();
                }, 5000);
            }

            showInstallPrompt() {
                document.getElementById('installBanner').style.display = 'block';
            }

            hideInstallPrompt() {
                document.getElementById('installBanner').style.display = 'none';
            }

            async installApp() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        this.showNotification('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'success');
                    }
                    
                    this.deferredPrompt = null;
                    this.hideInstallPrompt();
                } else {
                    this.showNotification('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ', 'warning');
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.secureChat = new SecureChatP2P();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            console.log('üöÄ SecureChat P2P –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
            console.log('üîê End-to-End —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
            console.log('üõ°Ô∏è –°–∏—Å—Ç–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≥–æ—Ç–æ–≤–∞');
        });

        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swScript = `
                    const CACHE_NAME = 'securechat-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('üì± PWA Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω'))
                    .catch(err => console.log('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ SW:', err));
            });
        }
    </script>
</body>
</html>
