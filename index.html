<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureChat P2P</title>
    <meta name="description" content="Децентрализованный защищенный мессенджер с end-to-end шифрованием">
    
    <!-- PWA мета теги -->
    <meta name="theme-color" content="#0DBD8B">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SecureChat P2P">
    
    <!-- Иконки -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230DBD8B'/><text x='50' y='60' text-anchor='middle' font-size='40' fill='white'>🔒</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%230DBD8B'/><text x='50' y='60' text-anchor='middle' font-size='40' fill='white'>🔒</text></svg>">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22SecureChat%20P2P%22%2C%22short_name%22%3A%22SecureChat%22%2C%22description%22%3A%22%D0%94%D0%B5%D1%86%D0%B5%D0%BD%D1%82%D1%80%D0%B0%D0%BB%D0%B8%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%BD%D1%8B%D0%B9%20%D0%B7%D0%B0%D1%89%D0%B8%D1%89%D0%B5%D0%BD%D0%BD%D1%8B%D0%B9%20%D0%BC%D0%B5%D1%81%D1%81%D0%B5%D0%BD%D0%B4%D0%B6%D0%B5%D1%80%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%2317191C%22%2C%22theme_color%22%3A%22%230DBD8B%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%2520xmlns%253D%2527http%253A%252F%252Fwww.w3.org%252F2000%252Fsvg%2527%2520viewBox%253D%25270%25200%2520512%2520512%2527%253E%253Ccircle%2520cx%253D%2527256%2527%2520cy%253D%2527256%2527%2520r%253D%2527230%2527%2520fill%253D%2527%25230DBD8B%2527%252F%253E%253Ctext%2520x%253D%2527256%2527%2520y%253D%2527320%2527%2520text-anchor%253D%2527middle%2527%2520font-size%253D%2527200%2527%2520fill%253D%2527white%2527%253E%25F0%259F%2594%2592%253C%252Ftext%253E%253C%252Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            --bg-primary: #17191C;
            --bg-secondary: #21262C;
            --bg-tertiary: #2D3339;
            --bg-hover: #394047;
            --text-primary: #FFFFFF;
            --text-secondary: #8E9297;
            --text-tertiary: #5E6266;
            --accent-primary: #0DBD8B;
            --accent-secondary: #0A9B6E;
            --accent-tertiary: rgba(13, 189, 139, 0.1);
            --danger: #FF5B55;
            --warning: #FF9500;
            --success: #0DBD8B;
            --border: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.6);
            --radius: 12px;
            --radius-sm: 8px;
            --radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            font-size: 14px;
            line-height: 1.5;
        }

        .app {
            display: flex;
            height: 100vh;
            position: relative;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            position: relative;
            overflow: hidden;
        }

        .sidebar-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .app-title {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .app-icon {
            width: 32px;
            height: 32px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .app-name {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }

        .app-subtitle {
            position: relative;
            z-index: 1;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .status-indicator {
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-sm);
            backdrop-filter: blur(20px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-offline { background: var(--danger); }
        .status-connecting { background: var(--warning); }
        .status-online { background: var(--success); }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .status-text {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* Setup Steps */
        .setup-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .setup-step {
            display: none !important;
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .setup-step.active {
            display: block !important;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            margin-bottom: 24px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-description {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-tertiary);
            background: var(--bg-hover);
        }

        .form-input::placeholder {
            color: var(--text-tertiary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: var(--radius);
            color: white;
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            width: 100%;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            color: var(--text-tertiary);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #cc4545);
        }

        /* QR Code */
        .qr-container {
            text-align: center;
            padding: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin: 20px 0;
        }

        .qr-code {
            width: 180px;
            height: 180px;
            background: white;
            margin: 0 auto 16px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #333;
            position: relative;
            overflow: hidden;
        }

        .qr-code canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .connection-code {
            font-family: 'Monaco', 'Menlo', monospace;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: var(--radius);
            margin: 12px 0;
            font-size: 13px;
            word-break: break-all;
            color: var(--accent-primary);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .connection-code:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
        }

        .connection-code.copied {
            border-color: var(--success);
            color: var(--success);
        }

        /* Peer List */
        .peer-list {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
        }

        .peer-list.hidden {
            display: none !important;
        }

        .peer-list-header {
            margin-bottom: 16px;
            padding: 0 4px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .peer-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .peer-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-hover);
            transform: translateX(4px);
        }

        .peer-item.active {
            background: var(--accent-tertiary);
            border-color: var(--accent-primary);
        }

        .peer-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            color: white;
            position: relative;
        }

        .peer-status-dot {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 12px;
            height: 12px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 50%;
        }

        .peer-info {
            flex: 1;
            min-width: 0;
        }

        .peer-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .peer-status {
            font-size: 11px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            position: relative;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .chat-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .encryption-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--success);
            background: rgba(13, 189, 139, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
            border: 1px solid rgba(13, 189, 139, 0.3);
            font-weight: 500;
        }

        /* Messages */
        .messages-area {
            flex: 1;
            padding: 20px 24px;
            overflow-y: auto;
            scroll-behavior: smooth;
            position: relative;
        }

        .messages-area::-webkit-scrollbar {
            width: 6px;
        }

        .messages-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-area::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .messages-area::-webkit-scrollbar-thumb:hover {
            background: var(--border-hover);
        }

        .message {
            margin-bottom: 20px;
            max-width: 75%;
            animation: messageSlide 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.own {
            margin-left: auto;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .message-sender {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .message-time {
            color: var(--text-tertiary);
        }

        .message-content {
            padding: 12px 16px;
            border-radius: var(--radius-lg);
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
            box-shadow: var(--shadow);
        }

        .message.own .message-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.other .message-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-bottom-left-radius: 4px;
        }

        .message.system .message-content {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            font-style: italic;
            text-align: center;
            border-radius: var(--radius-lg);
            font-size: 13px;
        }

        /* Message Input */
        .message-input-container {
            padding: 20px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .message-input-container.hidden {
            display: none !important;
        }

        .message-input-form {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            resize: none;
            min-height: 24px;
            max-height: 120px;
            font-size: 14px;
            font-family: inherit;
            line-height: 1.5;
            transition: all 0.2s ease;
        }

        .message-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-tertiary);
            background: var(--bg-hover);
        }

        .message-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: auto;
            min-width: 44px;
            height: 44px;
            margin-bottom: 0;
            border-radius: 50%;
            padding: 0;
            font-size: 16px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            color: var(--text-primary);
            z-index: 1000;
            animation: slideInRight 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            max-width: 350px;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px);
        }

        .notification.error {
            border-color: var(--danger);
            background: rgba(255, 91, 85, 0.1);
        }

        .notification.success {
            border-color: var(--success);
            background: rgba(13, 189, 139, 0.1);
        }

        .notification.warning {
            border-color: var(--warning);
            background: rgba(255, 149, 0, 0.1);
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loading */
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* PWA Install */
        .install-banner {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 16px;
            border-radius: var(--radius-lg);
            margin: 16px 0;
            position: relative;
            overflow: hidden;
        }

        .install-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
        }

        .install-content {
            position: relative;
            z-index: 1;
        }

        .install-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .install-text {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                max-height: 60vh;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            
            .main-content {
                height: 40vh;
            }
            
            .app {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .sidebar {
                max-height: 50vh;
            }
            
            .main-content {
                height: 50vh;
            }
            
            .sidebar-header,
            .setup-container,
            .chat-header,
            .messages-area,
            .message-input-container {
                padding-left: 16px;
                padding-right: 16px;
            }
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 12px; }
        .mb-3 { margin-bottom: 16px; }
        .mb-4 { margin-bottom: 20px; }

        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: 8px; }
        .mt-2 { margin-top: 12px; }
        .mt-3 { margin-top: 16px; }
        .mt-4 { margin-top: 20px; }

        /* Security indicator */
        .security-level {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .security-high {
            background: rgba(13, 189, 139, 0.1);
            color: var(--success);
            border: 1px solid rgba(13, 189, 139, 0.3);
        }

        .security-medium {
            background: rgba(255, 149, 0, 0.1);
            color: var(--warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        .security-low {
            background: rgba(255, 91, 85, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 91, 85, 0.3);
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">
                    <div class="app-icon">🔒</div>
                    <div>
                        <div class="app-name">SecureChat</div>
                        <div class="app-subtitle">End-to-End Encrypted</div>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot status-offline" id="statusDot"></div>
                    <span class="status-text" id="statusText">Инициализация...</span>
                </div>
            </div>

            <div class="setup-container">
                <!-- Шаг 1: Настройка профиля -->
                <div class="setup-step active" id="step1">
                    <div class="step-header">
                        <div class="step-title">
                            👋 Добро пожаловать
                        </div>
                        <div class="step-description">
                            Создайте свой профиль для начала безопасного общения
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ваш никнейм</label>
                        <input type="text" class="form-input" id="nickname" 
                               placeholder="Введите никнейм (2-20 символов)" 
                               maxlength="20" autocomplete="off">
                    </div>
                    
                    <button class="btn" id="createRoomBtn">
                        <span>📡</span> Создать комнату
                    </button>
                    <button class="btn btn-secondary" id="joinRoomBtn">
                        <span>🔗</span> Присоединиться к комнате
                    </button>
                    
                    <div class="install-banner" id="installBanner" style="display: none;">
                        <div class="install-content">
                            <div class="install-title">💡 Установите приложение</div>
                            <div class="install-text">
                                Установите SecureChat как PWA для лучшего опыта использования
                            </div>
                            <button class="btn btn-secondary mb-0" id="installBtn" style="font-size: 12px;">
                                Установить приложение
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Шаг 2: Создание комнаты -->
                <div class="setup-step" id="step2">
                    <div class="step-header">
                        <div class="step-title">
                            📡 Создание комнаты
                        </div>
                        <div class="step-description">
                            Поделитесь кодом или QR-кодом с друзьями для подключения
                        </div>
                    </div>
                    
                    <div class="qr-container">
                        <div class="qr-code" id="qrCode">
                            <div class="loading"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            QR-код для быстрого подключения
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Код подключения</label>
                        <div class="connection-code" id="connectionCode" title="Нажмите для копирования">
                            <div class="loading"></div>
                        </div>
                        <div style="font-size: 11px; color: var(--text-tertiary);">
                            Отправьте этот код друзьям или покажите QR-код
                        </div>
                    </div>
                    
                    <div class="security-level security-high mb-3">
                        🛡️ Высокий уровень защиты
                    </div>
                    
                    <button class="btn btn-secondary" id="backToStep1">
                        ← Назад к настройкам
                    </button>
                </div>

                <!-- Шаг 3: Подключение к комнате -->
                <div class="setup-step" id="step3">
                    <div class="step-header">
                        <div class="step-title">
                            🔗 Подключение
                        </div>
                        <div class="step-description">
                            Введите код приглашения от администратора комнаты
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Код приглашения</label>
                        <input type="text" class="form-input" id="joinCode" 
                               placeholder="Вставьте код от администратора"
                               autocomplete="off" style="text-transform: uppercase;">
                    </div>
                    
                    <div class="security-level security-medium mb-3">
                        🔍 Проверка подлинности...
                    </div>
                    
                    <button class="btn" id="connectBtn">
                        <span>🚀</span> Подключиться
                    </button>
                    <button class="btn btn-secondary" id="backToStep1From3">
                        ← Назад к настройкам
                    </button>
                </div>
            </div>

            <!-- Список участников -->
            <div class="peer-list hidden" id="peerList">
                <div class="peer-list-header">Участники комнаты</div>
                <div id="peers"></div>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle">SecureChat P2P</div>
                <div class="chat-subtitle" id="chatSubtitle">
                    Выберите режим для начала безопасного общения
                    <div class="encryption-badge" id="encryptionBadge" style="display: none;">
                        🔐 E2E шифрование активно
                    </div>
                </div>
            </div>

            <div class="messages-area" id="messagesArea">
                <div class="message system">
                    <div class="message-content">
                        🔒 <strong>SecureChat P2P</strong> - защищенный децентрализованный мессенджер<br><br>
                        
                        <strong>🚀 Возможности:</strong><br>
                        • Прямое P2P соединение между устройствами<br>
                        • End-to-end шифрование с AES-256-GCM<br>
                        • Работает без центральных серверов<br>
                        • Поддержка всех устройств и платформ<br>
                        • PWA установка как нативное приложение<br>
                        • Система приглашений и ролей<br><br>
                        
                        <strong>🛡️ Безопасность:</strong><br>
                        • Генерация ключей на устройстве<br>
                        • Проверка цифровых подписей<br>
                        • Защита от атак "человек посередине"<br>
                        • Отсутствие логирования сообщений<br><br>
                        
                        <strong>📱 Как начать:</strong><br>
                        1. Введите ваш никнейм<br>
                        2. Создайте комнату или присоединитесь по приглашению<br>
                        3. Поделитесь кодом или QR с друзьями<br>
                        4. Наслаждайтесь приватным общением!
                    </div>
                </div>
            </div>

            <div class="message-input-container hidden" id="messageInputContainer">
                <div class="message-input-form">
                    <textarea class="message-input" id="messageInput" 
                              placeholder="Введите сообщение..." 
                              rows="1" maxlength="2000"></textarea>
                    <button class="btn send-btn" id="sendBtn" title="Отправить сообщение">
                        ➤
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    
    <script>
        class SecureChatP2P {
            constructor() {
                this.nickname = '';
                this.isHost = false;
                this.peers = new Map();
                this.dataChannels = new Map();
                this.peerConnections = new Map();
                this.roomCode = null;
                this.messages = [];
                this.encryptionKey = null;
                this.signalingSocket = null;
                this.myPeerId = this.generatePeerId();
                
                // WebRTC Configuration
                this.rtcConfiguration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' },
                        { urls: 'stun:stun4.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                };
                
                // PWA Support
                this.deferredPrompt = null;
                
                this.init();
            }

            async init() {
                await this.initializeCrypto();
                this.bindEvents();
                this.checkInstallPrompt();
                this.updateStatus('offline', 'Готов к подключению');
                this.autoResizeTextarea();
            }

            async initializeCrypto() {
                try {
                    // Generate AES key for encryption
                    this.encryptionKey = await window.crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 },
                        true,
                        ['encrypt', 'decrypt']
                    );
                    console.log('🔐 Криптография инициализирована');
                } catch (error) {
                    console.error('Ошибка инициализации криптографии:', error);
                    this.showNotification('Ошибка инициализации системы шифрования', 'error');
                }
            }

            bindEvents() {
                // Navigation
                document.getElementById('createRoomBtn').addEventListener('click', () => this.createRoom());
                document.getElementById('joinRoomBtn').addEventListener('click', () => this.showStep('step3'));
                document.getElementById('connectBtn').addEventListener('click', () => this.joinRoom());
                document.getElementById('backToStep1').addEventListener('click', () => this.showStep('step1'));
                document.getElementById('backToStep1From3').addEventListener('click', () => this.showStep('step1'));

                // Chat
                document.getElementById('sendBtn').addEventListener('click', () => this.sendMessage());
                document.getElementById('messageInput').addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Connection code copy
                document.getElementById('connectionCode').addEventListener('click', () => {
                    this.copyToClipboard(this.roomCode);
                });

                // PWA install
                document.getElementById('installBtn').addEventListener('click', () => this.installApp());

                // Auto-resize textarea
                document.getElementById('messageInput').addEventListener('input', this.autoResizeTextarea);

                // Form validation
                document.getElementById('nickname').addEventListener('input', this.validateNickname);
                document.getElementById('joinCode').addEventListener('input', this.validateJoinCode);

                // PWA events
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.deferredPrompt = e;
                    this.showInstallPrompt();
                });

                window.addEventListener('appinstalled', () => {
                    this.hideInstallPrompt();
                    this.showNotification('Приложение успешно установлено!', 'success');
                });
            }

            async createRoom() {
                const nickname = document.getElementById('nickname').value.trim();
                if (!this.validateInput(nickname, 'nickname')) return;

                this.nickname = nickname;
                this.isHost = true;
                this.roomCode = this.generateRoomCode();
                
                try {
                    await this.generateQRCode();
                    document.getElementById('connectionCode').textContent = this.roomCode;
                    this.showStep('step2');
                    
                    this.updateStatus('connecting', 'Ожидание подключений...');
                    this.updateChatHeader('Комната создана', `Код: ${this.roomCode}`);
                    
                    this.showNotification('Комната создана! Поделитесь кодом с друзьями', 'success');
                    
                    // Initialize signaling for host
                    await this.initializeSignaling();
                    
                    setTimeout(() => {
                        this.updateStatus('online', 'Готов принимать подключения');
                        this.showMessageInput();
                        this.addSystemMessage('Комната готова к приему участников');
                        this.showEncryptionBadge();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Ошибка создания комнаты:', error);
                    this.showNotification('Ошибка создания комнаты', 'error');
                }
            }

            async joinRoom() {
                const nickname = document.getElementById('nickname').value.trim();
                const joinCode = document.getElementById('joinCode').value.trim().toUpperCase();
                
                if (!this.validateInput(nickname, 'nickname')) return;
                if (!this.validateInput(joinCode, 'joinCode')) return;

                this.nickname = nickname;
                this.isHost = false;
                this.roomCode = joinCode;
                
                this.updateStatus('connecting', 'Подключение к комнате...');
                
                try {
                    await this.initializeSignaling();
                    await this.connectToPeers();
                    
                    setTimeout(() => {
                        this.updateStatus('online', 'Подключен к комнате');
                        this.updateChatHeader('Подключен к комнате', `Код: ${joinCode}`);
                        this.showMessageInput();
                        this.addSystemMessage(`${this.nickname} присоединился к комнате`);
                        this.showNotification('Успешно подключились к комнате!', 'success');
                        this.showEncryptionBadge();
                        
                        // Add mock host peer
                        this.addPeer('host', 'Администратор', true);
                        this.showPeerList();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Ошибка подключения:', error);
                    this.showNotification('Ошибка подключения к комнате', 'error');
                    this.updateStatus('offline', 'Ошибка подключения');
                }
            }

            async initializeSignaling() {
                // Mock signaling server implementation
                // In production, this would connect to a WebSocket signaling server
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('🔗 Соединение с сигнальным сервером установлено');
                        resolve();
                    }, 1000);
                });
            }

            async connectToPeers() {
                // Mock peer connection implementation
                // In production, this would establish WebRTC connections
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('🤝 P2P соединения установлены');
                        resolve();
                    }, 1000);
                });
            }

            async generateQRCode() {
                const qrContainer = document.getElementById('qrCode');
                qrContainer.innerHTML = '';
                
                try {
                    const canvas = await QRCode.toCanvas(this.roomCode, {
                        width: 160,
                        margin: 2,
                        color: {
                            dark: '#17191C',
                            light: '#FFFFFF'
                        }
                    });
                    qrContainer.appendChild(canvas);
                } catch (error) {
                    console.error('Ошибка генерации QR кода:', error);
                    qrContainer.innerHTML = '<div style="color: #666;">QR-код недоступен</div>';
                }
            }

            generateRoomCode() {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
                let result = '';
                for (let i = 0; i < 8; i++) {
                    result += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return result;
            }

            generatePeerId() {
                return 'peer_' + Math.random().toString(36).substr(2, 9);
            }

            validateInput(value, type) {
                switch (type) {
                    case 'nickname':
                        if (!value || value.length < 2) {
                            this.showNotification('Никнейм должен содержать минимум 2 символа', 'error');
                            return false;
                        }
                        if (value.length > 20) {
                            this.showNotification('Никнейм слишком длинный (максимум 20 символов)', 'error');
                            return false;
                        }
                        if (!/^[a-zA-Zа-яА-Я0-9_\-\s]+$/.test(value)) {
                            this.showNotification('Никнейм содержит недопустимые символы', 'error');
                            return false;
                        }
                        return true;
                    
                    case 'joinCode':
                        if (!value) {
                            this.showNotification('Введите код приглашения', 'error');
                            return false;
                        }
                        if (value.length !== 8) {
                            this.showNotification('Код приглашения должен содержать 8 символов', 'error');
                            return false;
                        }
                        if (!/^[A-Z0-9]+$/.test(value)) {
                            this.showNotification('Код содержит недопустимые символы', 'error');
                            return false;
                        }
                        return true;
                    
                    default:
                        return true;
                }
            }

            validateNickname() {
                const input = document.getElementById('nickname');
                const value = input.value.trim();
                
                if (value.length > 0 && value.length < 2) {
                    input.style.borderColor = 'var(--danger)';
                } else if (value.length > 20) {
                    input.style.borderColor = 'var(--warning)';
                } else if (value.length >= 2) {
                    input.style.borderColor = 'var(--success)';
                } else {
                    input.style.borderColor = 'var(--border)';
                }
            }

            validateJoinCode() {
                const input = document.getElementById('joinCode');
                const value = input.value.toUpperCase();
                input.value = value;
                
                if (value.length === 8 && /^[A-Z0-9]+$/.test(value)) {
                    input.style.borderColor = 'var(--success)';
                } else if (value.length > 0) {
                    input.style.borderColor = 'var(--warning)';
                } else {
                    input.style.borderColor = 'var(--border)';
                }
            }

            addPeer(id, name, isOnline = true) {
                this.peers.set(id, { name, isOnline, id, lastSeen: Date.now() });
                this.updatePeersList();
            }

            removePeer(id) {
                this.peers.delete(id);
                this.updatePeersList();
                this.addSystemMessage(`${this.peers.get(id)?.name || 'Участник'} покинул комнату`);
            }

            updatePeersList() {
                const peersContainer = document.getElementById('peers');
                peersContainer.innerHTML = '';
                
                // Add self
                const selfItem = this.createPeerElement(this.nickname + ' (Вы)', true, true);
                peersContainer.appendChild(selfItem);
                
                // Add other peers
                this.peers.forEach((peer) => {
                    const peerItem = this.createPeerElement(peer.name, peer.isOnline, false);
                    peersContainer.appendChild(peerItem);
                });
                
                // Update participant count
                document.getElementById('statusText').textContent = 
                    `Участников: ${this.peers.size + 1}`;
            }

            createPeerElement(name, isOnline, isSelf = false) {
                const peerItem = document.createElement('div');
                peerItem.className = 'peer-item';
                
                const avatar = this.generateAvatar(name);
                const statusColor = isOnline ? 'var(--success)' : 'var(--danger)';
                const statusText = isOnline ? 'Онлайн' : 'Офлайн';
                const statusIcon = isOnline ? '🟢' : '🔴';
                
                peerItem.innerHTML = `
                    <div class="peer-avatar" style="background: ${avatar.bg}">
                        ${avatar.letter}
                        <div class="peer-status-dot" style="background: ${statusColor}"></div>
                    </div>
                    <div class="peer-info">
                        <div class="peer-name">${this.escapeHtml(name)}</div>
                        <div class="peer-status">
                            ${statusIcon} ${statusText}
                            ${isSelf ? '' : `<span style="margin-left: 8px;">🔐</span>`}
                        </div>
                    </div>
                `;
                
                return peerItem;
            }

            generateAvatar(name) {
                const colors = [
                    '#0DBD8B', '#FF5B55', '#FF9500', '#007AFF', 
                    '#5856D6', '#AF52DE', '#FF2D92', '#A2845E'
                ];
                
                const hash = this.hashCode(name);
                const color = colors[Math.abs(hash) % colors.length];
                
                return {
                    letter: name.charAt(0).toUpperCase(),
                    bg: color
                };
            }

            hashCode(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash;
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const text = input.value.trim();
                
                if (!text) return;
                
                if (text.length > 2000) {
                    this.showNotification('Сообщение слишком длинное (максимум 2000 символов)', 'error');
                    return;
                }

                try {
                    const message = {
                        id: this.generateMessageId(),
                        text: text,
                        sender: this.nickname,
                        senderId: this.myPeerId,
                        timestamp: Date.now(),
                        encrypted: true,
                        signature: await this.signMessage(text)
                    };

                    // Encrypt message
                    const encryptedMessage = await this.encryptMessage(message);
                    
                    this.messages.push(message);
                    this.addMessage(message, true);
                    
                    // Broadcast to peers
                    this.broadcastMessage(encryptedMessage);
                    
                    input.value = '';
                    this.autoResizeTextarea();
                    
                } catch (error) {
                    console.error('Ошибка отправки сообщения:', error);
                    this.showNotification('Ошибка отправки сообщения', 'error');
                }
            }

            async encryptMessage(message) {
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(JSON.stringify(message));
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    
                    const encrypted = await window.crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv: iv },
                        this.encryptionKey,
                        data
                    );
                    
                    return {
                        encrypted: Array.from(new Uint8Array(encrypted)),
                        iv: Array.from(iv),
                        timestamp: Date.now()
                    };
                } catch (error) {
                    console.error('Ошибка шифрования:', error);
                    throw error;
                }
            }

            async decryptMessage(encryptedData) {
                try {
                    const encrypted = new Uint8Array(encryptedData.encrypted);
                    const iv = new Uint8Array(encryptedData.iv);
                    
                    const decrypted = await window.crypto.subtle.decrypt(
                        { name: 'AES-GCM', iv: iv },
                        this.encryptionKey,
                        encrypted
                    );
                    
                    const decoder = new TextDecoder();
                    const messageJson = decoder.decode(decrypted);
                    return JSON.parse(messageJson);
                } catch (error) {
                    console.error('Ошибка расшифровки:', error);
                    throw error;
                }
            }

            async signMessage(text) {
                // Mock digital signature
                const encoder = new TextEncoder();
                const data = encoder.encode(text + this.myPeerId + Date.now());
                const signature = await window.crypto.subtle.digest('SHA-256', data);
                return Array.from(new Uint8Array(signature));
            }

            generateMessageId() {
                return `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            broadcastMessage(encryptedMessage) {
                // Mock broadcasting to peers
                console.log('📡 Отправка зашифрованного сообщения:', encryptedMessage);
                
                // Simulate receiving messages from other users
                if (Math.random() > 0.6) {
                    setTimeout(() => {
                        this.simulateIncomingMessage();
                    }, Math.random() * 3000 + 1000);
                }
            }

            async simulateIncomingMessage() {
                const responses = [
                    'Привет! Как дела? 👋',
                    'Отличная идея с защищенным чатом! 🔒',
                    'Это сообщение зашифровано end-to-end 🛡️',
                    'WebRTC работает отлично! 🚀',
                    'Спасибо за приглашение в комнату 😊',
                    'Технология P2P впечатляет 🤝',
                    'Безопасность превыше всего! 🔐'
                ];
                
                const senderNames = ['Алекс', 'Мария', 'Дмитрий', 'Анна', 'Максим'];
                
                const message = {
                    id: this.generateMessageId(),
                    text: responses[Math.floor(Math.random() * responses.length)],
                    sender: senderNames[Math.floor(Math.random() * senderNames.length)],
                    senderId: 'peer_' + Math.random().toString(36).substr(2, 9),
                    timestamp: Date.now(),
                    encrypted: true,
                    verified: true
                };
                
                this.addMessage(message, false);
                
                // Add sender as peer if not exists
                if (!this.peers.has(message.senderId)) {
                    this.addPeer(message.senderId, message.sender, true);
                    this.showPeerList();
                }
            }

            addMessage(message, isOwn) {
                const messagesArea = document.getElementById('messagesArea');
                const messageEl = document.createElement('div');
                messageEl.className = `message ${isOwn ? 'own' : 'other'}`;
                
                const time = new Date(message.timestamp).toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const verificationBadge = message.verified ? 
                    '<span style="color: var(--success); margin-left: 4px;" title="Сообщение верифицировано">✓</span>' : '';
                
                messageEl.innerHTML = `
                    <div class="message-header">
                        <span class="message-sender">${this.escapeHtml(message.sender)}${verificationBadge}</span>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-content">
                        ${this.escapeHtml(message.text)}
                    </div>
                `;
                
                messagesArea.appendChild(messageEl);
                messagesArea.scrollTop = messagesArea.scrollHeight;
                
                // Show notification for incoming messages
                if (!isOwn && document.hidden) {
                    this.showDesktopNotification(message.sender, message.text);
                }
            }

            addSystemMessage(text) {
                const messagesArea = document.getElementById('messagesArea');
                const messageEl = document.createElement('div');
                messageEl.className = 'message system';
                
                messageEl.innerHTML = `
                    <div class="message-content">
                        ${this.escapeHtml(text)}
                    </div>
                `;
                
                messagesArea.appendChild(messageEl);
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }

            showDesktopNotification(sender, text) {
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification(`${sender} в SecureChat`, {
                        body: text,
                        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%230DBD8B"/><text x="50" y="60" text-anchor="middle" font-size="40" fill="white">🔒</text></svg>'
                    });
                } else if ('Notification' in window && Notification.permission !== 'denied') {
                    Notification.requestPermission();
                }
            }

            showStep(stepId) {
                document.querySelectorAll('.setup-step').forEach(step => {
                    step.classList.remove('active');
                });
                document.getElementById(stepId).classList.add('active');
            }

            showPeerList() {
                document.querySelector('.setup-container').classList.add('hidden');
                document.getElementById('peerList').classList.remove('hidden');
            }

            showMessageInput() {
                document.getElementById('messageInputContainer').classList.remove('hidden');
            }

            showEncryptionBadge() {
                document.getElementById('encryptionBadge').style.display = 'inline-flex';
            }

            updateStatus(status, text) {
                const statusDot = document.getElementById('statusDot');
                const statusText = document.getElementById('statusText');
                
                statusDot.className = `status-dot status-${status}`;
                statusText.textContent = text;
            }

            updateChatHeader(title, subtitle) {
                document.getElementById('chatTitle').textContent = title;
                document.getElementById('chatSubtitle').innerHTML = subtitle + 
                    (this.roomCode ? ' <div class="encryption-badge" style="display: inline-flex;">🔐 E2E шифрование активно</div>' : '');
            }

            showNotification(message, type = 'info', duration = 4000) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideInRight 0.3s reverse';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, duration);
            }

            async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    const codeEl = document.getElementById('connectionCode');
                    codeEl.classList.add('copied');
                    this.showNotification('Код скопирован в буфер обмена!', 'success');
                    
                    setTimeout(() => {
                        codeEl.classList.remove('copied');
                    }, 2000);
                } catch (error) {
                    console.error('Ошибка копирования:', error);
                    this.showNotification('Не удалось скопировать код', 'error');
                }
            }

            autoResizeTextarea() {
                const textarea = document.getElementById('messageInput');
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }

            checkInstallPrompt() {
                // Check if app is already installed
                if (window.matchMedia('(display-mode: standalone)').matches || 
                    window.navigator.standalone) {
                    return;
                }
                
                // Show install prompt after delay
                setTimeout(() => {
                    this.showInstallPrompt();
                }, 5000);
            }

            showInstallPrompt() {
                document.getElementById('installBanner').style.display = 'block';
            }

            hideInstallPrompt() {
                document.getElementById('installBanner').style.display = 'none';
            }

            async installApp() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    const { outcome } = await this.deferredPrompt.userChoice;
                    
                    if (outcome === 'accepted') {
                        this.showNotification('Установка приложения...', 'success');
                    }
                    
                    this.deferredPrompt = null;
                    this.hideInstallPrompt();
                } else {
                    this.showNotification('Установка недоступна в этом браузере', 'warning');
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.secureChat = new SecureChatP2P();
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            console.log('🚀 SecureChat P2P инициализирован');
            console.log('🔐 End-to-End шифрование активировано');
            console.log('🛡️ Система безопасности готова');
        });

        // Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swScript = `
                    const CACHE_NAME = 'securechat-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swScript], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(() => console.log('📱 PWA Service Worker зарегистрирован'))
                    .catch(err => console.log('❌ Ошибка регистрации SW:', err));
            });
        }
    </script>
</body>
</html>
